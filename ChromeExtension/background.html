<html>
  <head>
    <script src="jquery-1.4.2.min.js" />
    <script>
      var lookupsByPage = new Array();

      // Listen for any changes to the URL of any tab.
//      chrome.tabs.onUpdated.addListener(checkForValidUrl);
    chrome.extension.onRequest.addListener(
       function(request, sender, sendResponse) 
       {
          if ( request.msg == 'lookup' )
          {
                chrome.pageAction.setTitle({tabId: sender.tab.id, title: 'LibraryLookup: searching'});
                // chrome.pageAction.onClicked.addListener(function(tab){});
                chrome.pageAction.show(sender.tab.id);


                var xhr = new XMLHttpRequest();
                xhr.open("GET", "http://librarylookup.appspot.com/isbn/" + request.isbn, true);
                xhr.onreadystatechange = function() 
                {
                    if (xhr.readyState == 4) 
                    {
                        chrome.pageAction.setTitle({tabId: sender.tab.id, title: 'LibraryLookup'});
                        lookupsByPage[sender.tab.url] = xhr.responseText;
                        if ( $("li", $(xhr.responseText)).length )
                        {
                            chrome.pageAction.setPopup({tabId: sender.tab.id, popup: 'popup.html'});
                            chrome.pageAction.setIcon({tabId: sender.tab.id, path: 'book_found.png'});
                        }
                        else
                        {
                            chrome.pageAction.setIcon({tabId: sender.tab.id, path: 'no_book_found.png'});
                        }
                        
                    }
                };
                xhr.send();
            }
         }
       );
             
    </script>
  </head>
</html>
  
